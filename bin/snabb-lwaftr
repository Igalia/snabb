#!/bin/bash

usage() {
   echo -e "usage: snabb-lwaftr --help"
   echo -e "       snabb-lwaftr --bt <binding-table> --conf <conf-file> --v4-pci <pci-addr> --v6-pci <pci-addr>"
   echo -e " "
   echo -e "       --bt <binding-table>\tSets binding table"
   echo -e "       --conf <conf-file>\tSets configuration policy table"
   echo -e "       --v4-pci <pci-addr>\tPCI device number for the INET-side NIC"
   echo -e "       --v6-pci <pci-addr>\tPCI device number for the B4-side NIC"
}

error() {
   local msg=$1

   usage
   echo "Error: $msg" >&2
   exit 1
}

# No arguments, print out usage
if [ $# -eq "0" ]; then
   usage
   exit 1
fi

# Include helper functions
dir="$(dirname "$0")"
source "$dir/snabb-lwaftr.inc.sh"

# Parse arguments
while [[ $# > 0 ]]; do
   key="$1"
   case $key in
      --bt)
         bt="$2"
         shift
      ;;
      --conf)
         conf="$2"
         shift
      ;;
      --v4-pci)
         v4_pci="$2"
         shift
      ;;
      --v6-pci)
         v6_pci="$2"
         shift
      ;;
      --help)
         usage
         exit 1
      ;;
   esac
   shift
done

if [ $EUID -ne 0 ]; then
   echo "This script must be run as root" 1>&2
   exit 1
fi

# Helper variables for default parameters
snabb_src=$(whereis_snabb_src)
snabb_dir=`dirname $snabb_src`
snabb_test=$snabb_dir/tests
snabb_test_data=$snabb_test/apps/lwaftr/data

# Default parameters
if [ -z "$bt" ]; then
   bt=$snabb_test_data/binding.table
fi
if [ -z "$conf" ]; then
   conf=$snabb_test_data/icmp_on_fail.conf
fi
if [ -z "$v4_pci" ]; then
   error "v4-pci not set"
fi
if [ -z "$v6_pci" ]; then
   error "v6-pci not set"
fi

# NIC addresses must start with '0000:'
if [[ ! $v4_pci =~ ^0000:* ]]; then
   v4_pci=0000:$v4_pci
fi
if [[ ! $v6_pci =~ ^0000:* ]]; then
   v6_pci=0000:$v6_pci
fi

# Check parameters are correct
if [ ! -f "$bt" ]; then
   error "Couldn't find binding table at '$bt'"
fi
if [ ! -f "$conf" ]; then
   error "Couldn't find configuration file at '$conf'"
fi
if ! nic_exists "$v4_pci"; then
   error "NIC address '$v4_pci' doesn't exist"
fi
if ! nic_exists "$v6_pci"; then
   error "NIC address '$v6_pci' doesn't exist"
fi

# Run lwaftr/nic_ui
sudo $snabb_src/snabb snsh $snabb_src/apps/lwaftr/nic_ui.lua \
   -v $bt $conf $v4_pci $v6_pci
